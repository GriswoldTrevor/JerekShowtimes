<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>IMAX Showtimes</title>
	<meta name="description" content="Film Showtimes">
	<meta name="author" content="Trevor Griswold">

	<style type="text/css">
		@media only screen and (max-width: 1499px) {
			body {
				font-size: 2em;
			}
			#CurrentTime, #PosterContainer, #ShowtimeContainer {
				border-top-width: 1px !important;
			}
			.FilmShowtimes:not(:last-child) {
				border-right-width: 1px !important;
			}
		}
		@media only screen and (min-width: 1500px) and (max-width: 1999px) {
			body {
				font-size: 2.5em;
			}
			#CurrentTime, #PosterContainer, #ShowtimeContainer {
				border-top-width: 2px !important;
			}
			.FilmShowtimes:not(:last-child) {
				border-right-width: 2px !important;
			}
		}
		@media only screen and (min-width: 2000px) and (max-width: 2499px) {
			body {
				font-size: 3em;
			}
			#CurrentTime, #PosterContainer, #ShowtimeContainer {
				border-top-width: 3px !important;
			}
			.FilmShowtimes:not(:last-child) {
				border-right-width: 3px !important;
			}
		}
		@media only screen and (min-width: 2500px) and (max-width: 2999px) {
			body {
				font-size: 3.5em;
			}
			#CurrentTime, #PosterContainer, #ShowtimeContainer {
				border-top-width: 4px !important;
			}
			.FilmShowtimes:not(:last-child) {
				border-right-width: 4px !important;
			}
		}
		@media only screen and (min-width: 3000px) and (max-width: 3499px) {
			body {
				font-size: 4.5em;
			}
			#CurrentTime, #PosterContainer, #ShowtimeContainer {
				border-top-width: 5px !important;
			}
			.FilmShowtimes:not(:last-child) {
				border-right-width: 5px !important;
			}
		}
		@media only screen  and (min-width: 3500px)  {
			body {
				font-size: 5em;
			}
			#CurrentTime, #PosterContainer, #ShowtimeContainer {
				border-top-width: 6px !important;
			}
			.FilmShowtimes:not(:last-child) {
				border-right-width: 6px !important;
			}
		}
		
		@font-face {
			font-family: Microgramma D Extended Bold;
			src: url('Microgramma D Extended Bold.otf') format("opentype");
		}
		
		#HeaderContainer {
			font-size: 2.5em !important;
		}
		.FilmPoster, #CurrentTime {
			font-size: 1em !important;
		}
		.FilmShowtimes {
			font-size: 0.85em !important;
		}
		
		#HeaderTitle {
			display: flex;
			justify-content: start;
			flex-direction: row;
		}
		
		.IMAX {
			font-family: Microgramma D Extended Bold;
			font-weight: normal;
		}
		.RegisteredTM {
			font-size: 0.25em;
			padding-top: 1.15em;
			padding-right: 1em;
			font-weight: normal;
		}
		
		.FilmPoster {
			height: 100%;
			text-align: center;
			font-weight: bold;
			position: relative;
		}
		.FilmPoster img {
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			margin:auto;
			position: absolute;
		
			max-height: 100%;
			max-width: 100%;
			width:auto;
			height:auto;
		}
		.FilmShowtimes {
			text-align: center;
			font-weight: bold;
			display: flex;
			justify-content: flex-start;
			flex-direction: column;
			flex-wrap: wrap;
			
			border-width: 0px 0px 0px 0px;
			border-style: solid;
			border-color: white;
			border-collapse: collapse;
		}
		.Showtime {
			text-align: center;
			padding: 10px 10px 10px 10px;
		}
		
		#CurrentTime, #PosterContainer, #ShowtimeContainer {
			border-color: #ffffff;
			border-style: solid;
			border-collapse: collapse;
			border-width: 0px 0px 0px 0px;
		}
		#HeaderContainer {
			height: 12%;
			background: #184896;
			
			font-weight: bold;
			text-align: left;
			
			display: flex;
			flex-direction: column;
			justify-content: center;
			padding-left: 0.25em;
		}
		#CurrentTime {
			height: 6%;
			
			font-weight: bold;
			text-align: right;
			
			display: flex;
			flex-direction: column;
			justify-content: center;
			padding-right: 0.625em;
		}
		#PosterContainer {
			height: 55%;
			
			background: #030b0f;
			display: flex;
			justify-content: space-between;
			flex-direction: row;
		}
		#ShowtimeContainer {
			height: 27%;
			
			display: flex;
			justify-content: space-between;
			flex-direction: row;
		}
		
		body {
			font-family: verdana !important;
			background: linear-gradient(to left, #0546B5, #1C76C9);
			color: white;
			
			display: flex;
			justify-content: center;
			flex-direction: column;
		}
		html, body {
			margin: 0;
			height: 100%;
		}
	</style>
</head>

<body>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script type="text/javascript">
		$( document ).ready(function() {
			setInterval(updateData, 1000);
		});
		
		var lastLoadedShowtimeDate = null;
		
		function updateData(){
			$("#CurrentTime").text(getDateTimeText());
			
			let today = new Date();
			today.setMinutes(0, 0, 0);
			if (lastLoadedShowtimeDate === null || lastLoadedShowtimeDate < today)
			{
				lastLoadedShowtimeDate = today;
				parseShowtimeData(today);
			}
		}
		
		function parseShowtimeData(today){
			const apiKey = 'AIzaSyCrkLGinkb81wYSHynyUAelArQnY2uHC_Q';
			const spreadsheetId = '1F5BzaAmANypyfKyoBZCzpeOgRfrivx9UwWeDLhvQx7U';
			const filmRange = 'Films!A2%3AC';
			const ShowtimeRange = 'Showtimes!A2%3AK';
			const settingsRange = 'Settings!A2:A';
			const renderOptions = 'dateTimeRenderOption=FORMATTED_STRING&majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE';
			
			$("#PosterContainer").empty();
			$("#ShowtimeContainer").empty();
			
			let parsedShowtimeData = {};
			const dayNumber = today.getDay();
			
			$.getJSON('https://sheets.googleapis.com/v4/spreadsheets/'+spreadsheetId+'/values/'+filmRange+'?'+renderOptions+'&key='+apiKey, function(data) {
				let filmData = data.values;
				for (let i = 0; i < filmData.length; i++) {
					if (filmData[i].length > 0) {
						const filmCode = (filmData[i][0] || "").toUpperCase();
						
						parsedShowtimeData[filmCode] = {
							name: filmData[i][1] || "",
							posterURL: filmData[i][2],
							Showtimes: []
						};
					}
				}
				$.getJSON('https://sheets.googleapis.com/v4/spreadsheets/'+spreadsheetId+'/values/'+ShowtimeRange+'?'+renderOptions+'&key='+apiKey, function(data) {
					let ShowtimeData = data.values;
					for (let i = 0; i < ShowtimeData.length; i++) {
						if (ShowtimeData[i].length === 11) {
							const startDate = new Date(ShowtimeData[i][2]);
							const endDate = new Date(ShowtimeData[i][3]);
							
							if (ShowtimeData[i][4+dayNumber].toUpperCase() === "Y" && startDate.getTime() <= today.getTime() && endDate.getTime() >= today.getTime()) {
								const filmCode = ShowtimeData[i][0].toUpperCase();
								if (parsedShowtimeData[filmCode] !== null && parsedShowtimeData[filmCode] !== undefined)
									parsedShowtimeData[filmCode].Showtimes.push(ShowtimeData[i][1]);
							}
						}
					}
					
					let posterContainer = $("#PosterContainer");
					let ShowtimeContainer = $("#ShowtimeContainer");
					
					let filmCount = 0;
					for (let p in parsedShowtimeData) {
						if (parsedShowtimeData.hasOwnProperty(p)) {
							if (parsedShowtimeData[p].Showtimes.length > 0) {
								filmCount++;
								if (parsedShowtimeData[p].posterURL !== null && parsedShowtimeData[p].posterURL !== undefined)
									posterContainer.append("<div class='FilmPoster'><img src='"+parsedShowtimeData[p].posterURL+"' alt='"+parsedShowtimeData[p].name+"'></div>");
								else
									posterContainer.append("<div class='FilmTitle'>"+parsedShowtimeData[p].name+"</div>");
									
								ShowtimeContainer.append("<div class='FilmShowtimes'><div class='Showtime'>"+sortByTime(parsedShowtimeData[p].Showtimes).join("</div><div class='Showtime'>")+"</div></div>");
							}
						}
					}
					$("#HeaderContainer").append('<style type="text/css">.FilmPoster, .FilmShowtimes, .FilmTitle { width: '+Math.floor(99.9/filmCount)+'%; }</style>');
				});
			});
		}
		
		function sortByTime(values) {
			return values.sort(function (t1, t2) { return new Date('1970/01/01 ' + t1) - new Date('1970/01/01 ' + t2);});
		}
		function getDateTimeText() {
			const dateTime = new Date();
			return (getDateText(dateTime) + " " + getTimeText(dateTime)).toUpperCase();
		}
		function getTimeText(time) {
			let timeSuffix = "am";
			let timeHours = time.getHours();
			if (timeHours == 0) {
			  timeHours = 12;
			  timeSuffix = "pm";
			} else if (timeHours > 12) {
			  timeHours = timeHours - 12;
			  timeSuffix = "pm";
			}
			return (timeHours + ":" + zeroPadNumber(time.getMinutes()) + " " + timeSuffix);
		}
		function getDateText(date) {
			return (getDayText(date.getDay()) + " " + getMonthText(date.getMonth()) + " " + getDateNumberText(date.getDate()));
		}
		function getDayText(dayNum) {
		  const dayArray = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
		  
		  if (dayNum >= 0 && dayNum < 7)
			return dayArray[dayNum];
		  else
			throw new TypeError("Invalid day number");
		}
		function getMonthText(monthNum) {
		  const monthArray = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
		  
		  if (monthNum >= 0 && monthNum < 12)
			return monthArray[monthNum];
		  else
			throw new TypeError("Invalid month number");
		}
		function getDateNumberText(dateNumber) {
			let dateNumberSuffix = "th";
			const onesDigit = dateNumber % 10;
			if (onesDigit == 1 && dateNumber != 11)
				dateNumberSuffix = "st";
			else if (onesDigit == 2 && dateNumber != 12)
				dateNumberSuffix = "nd";
			else if (onesDigit == 3 && dateNumber != 13)
				dateNumberSuffix = "rd";
			return dateNumber + dateNumberSuffix;
		}
		function zeroPadNumber(num) {
			let numText = num;
			if (num < 10)
				numText = "0" + numText;
			return numText;
		}
	</script>
	<div id="HeaderContainer">
		<div id="HeaderTitle">
			<span class='IMAX'>IMAX</span>
			<span class='RegisteredTM'>&reg;</span>
			SHOWTIMES
		</div>
	</div>
	<div id="CurrentTime"></div>
	<div id="PosterContainer"></div>
	<div id="ShowtimeContainer"></div>
</body>
</html>
